<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.javatree.www.DAO.QnaDAO">
	
	<resultMap type="Question" id="QuestionMap">
		<result property="questionno" column="questionno"/>
		<result property="typeno" column="typeno"/>
		<result property="codingno" column="codingno"/>
		<result property="id" column="id"/>
		<result property="username" column="username"/>
		<result property="title" column="title"/>
		<result property="content"  column="content"  jdbcType="CLOB" javaType="java.lang.String" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
		<result property="regdate" column="regdate"/>
		<result property="hitcount" column="hitcount"/>
		<result property="curious" column="curious"/>
	</resultMap>
	
	<resultMap type="Reply" id="ReplyMap">
		<result property="questionno" column="questionno"/>
		<result property="replyno" column="replyno"/>
		<result property="id" column="id"/>
		<result property="username" column="username"/>
		<result property="content"  column="content"  jdbcType="CLOB" javaType="java.lang.String" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
		<result property="regdate" column="regdate"/>
		<result property="recommand" column="recommand"/>
		<collection property="rereplyList" javaType="java.util.ArrayList" column="replyno" ofType="Rereply" select="selectAllRereply"/>
	</resultMap>
	
	<insert id="insertQuestion" parameterType="Question">
		insert into question
		(questionno, typeno
		<if test="codingno != null">
		, codingno
		</if>
		, id, username, title, content
		) 
		values
		(
		question_seq.nextVal
		, #{typeno}
		<if test="codingno != null">
		, #{codingno}
		</if>
		, #{id}
		, #{username}
		, #{title}
		, #{content:VARCHAR}
		)
	</insert>
	
	<insert id="insertReply" parameterType="Reply">
		insert into reply
		(questionno, replyno, id, username, content
		) 
		values
		(
		#{questionno}
		, reply_seq.nextVal
		, #{id}
		, #{username}
		, #{content:VARCHAR}
		)
	</insert>
	
	<insert id = "insertRereply" parameterType="Rereply">
		insert into rereply
		(replyno, id, content, username, recommand
		) 
		values
		(
		#{replyno}
		, #{id}
		, #{content}
		, #{username}
		, 0
		)
	</insert>
	<select id="getTotal" resultType="int">
		select count(*) from question
	</select>
	
	<select id="selectAllQuestion" parameterType="map" resultMap="QuestionMap">
		SELECT questionno, typeno, codingno, id, username, title,
		content, to_char(regdate, 'YYYY-MM-DD') as regdate, hitcount, curious from
		 (select rownum as rnum, T1.* from (select * from question
		 <where>
		 	<if test="typenoList != null">
			 	typeno in
			 	<foreach collection="typenoList" item="type" index="index" separator="," open="(" close=")">
	            #{type}
	        	</foreach>
		 	</if>
		 </where>
		  order by questionno desc) T1)
 		where rnum <![CDATA[>]]>= #{start} and rnum <![CDATA[<]]>= #{end} 
	</select>

	<select id="gunggumAllQuestionList" resultMap="QuestionMap">
		SELECT questionno, typeno, codingno, id, username, title,
		content, to_char(regdate, 'YYYY-MM-DD') as regdate, hitcount, curious from
		 (select rownum as rnum, T1.* from (select * from question order by curious desc) T1)
 		where rnum <![CDATA[>]]>= 1 and rnum <![CDATA[<]]>= 3
	</select>
	
	<select id="gunggumRecentQuestionList" resultMap="QuestionMap">
		SELECT questionno, typeno, codingno, id, username, title,
		content, to_char(regdate, 'YYYY-MM-DD') as regdate, hitcount, curious from
		 (select rownum as rnum, T1.* from (select * from question where add_months(sysdate, -3) 
		 <![CDATA[<]]>= regdate order by curious desc) T1)
 		where rnum <![CDATA[>]]>= 1 and rnum <![CDATA[<]]>= 3
	</select>
	
	<select id="bestAllQuestionList" resultMap="QuestionMap">
		select * from question where questionno in (SELECT questionno from
		 (select rownum as rnum, T1.* from (select * from question order by curious desc) T1)
 		where rnum <![CDATA[>]]>= 1 and rnum <![CDATA[<]]>= 3)
	</select>
	
	<select id="bestRecentQuestionList" resultMap="QuestionMap">
		select * from question where questionno in (SELECT questionno from
		 (select rownum as rnum, T1.* from (select * from question where add_months(sysdate, -3) 
		 <![CDATA[<]]>= regdate order by curious desc) T1)
 		where rnum <![CDATA[>]]>= 1 and rnum <![CDATA[<]]>= 3)
	</select>
	
	<select id="selectOneQuestion" parameterType="int" resultMap="QuestionMap">
		select questionno, typeno, codingno, id, username, title,
		content, to_char(regdate, 'YYYY-MM-DD') as regdate, hitcount, curious from question where questionno = #{questionno}
	</select>
	
	<select id="selectAllReply" parameterType="int" resultMap="ReplyMap">
		select * from reply where questionno = #{questionno}
	</select>
	
	<select id="selectAllRereply" parameterType="int" resultType="Rereply">
		select * from rereply where replyno = #{replyno}
	</select>
	
	<!-- <insert id="insert"> 
	
	</insert> -->
	
</mapper>